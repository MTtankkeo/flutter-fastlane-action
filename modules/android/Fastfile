# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools

default_platform(:android)

platform :android do
  desc "Build and upload to Play Store"
  lane :deploy do |options|
    version_name = options[:version_name]
    build_number = options[:build_number]
    release_note = options[:release_note]
    release_note_language = options[:release_note_language]
    build_extra = options[:build_extra]
    build_dest_path = options[:build_dest_path]
    isDraft = options[:draft]

    # Determine whether to submit for automatic review
    auto_review_submit = !release_note.nil? && release_note.strip != ""

    if auto_review_submit
      puts "ðŸ“¤ Automatic submission enabled based on provided release notes."
      release_note = release_note.gsub("\\n", "\n")
    end

    command = [
      "flutter build appbundle --release",
      "--build-name=#{version_name}",
      "--build-number=#{build_number}",
      build_extra
    ].compact.join(" ").strip

    # Build the Android app
    sh(command)

    # The absolute path where the built Android App Bundle (AAB) will be saved.
    # The path is resolved relative to this `fastfile/` directory.
    output_path = Dir.glob(File.expand_path("../../build/app/outputs/bundle/**/*.aab", __dir__)).first

    # Determine the Flutter project root directory.
    flutter_root = File.expand_path("../..", __dir__)

    # Resolve the destination path for the AAB relative to the Flutter root.
    dest_path = File.expand_path(build_dest_path, flutter_root)

    # Ensure the destination directory exists, then copy the AAB file there.
    require 'fileutils'
    FileUtils.mkdir_p(File.dirname(dest_path))
    FileUtils.cp(output_path, dest_path)

    # Upload to Play Store
    upload_args = {
      aab: output_path,
      track: auto_review_submit ? "production" : "internal",
      release_status: isDraft ? "draft" : "completed",
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: true
    }

    # Define release notes for automatic review submission
    if auto_review_submit
      upload_args[:skip_upload_changelogs] = false
      upload_args[:whats_new] = {
        release_note_language => release_note
      }
    end

    upload_to_play_store(upload_args)
  end
end
